{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## Front Door WAF triage workbook\n---\n\nThis workbook will help you triage Front Door WAF violations."
      },
      "name": "text - 2"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "63ea93e5-3270-4447-9572-ad9e62095e7b",
            "version": "KqlParameterItem/1.0",
            "name": "subscription",
            "label": "Subscription",
            "type": 6,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "value": [
              "/subscriptions/f164a5a8-a5ce-4c29-a374-8a27bd327d18"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "includeAll": false
            }
          },
          {
            "id": "12476248-81b7-46af-a9b4-790f93306442",
            "version": "KqlParameterItem/1.0",
            "name": "workspace",
            "label": "Workspace",
            "type": 5,
            "isRequired": true,
            "query": "where type =~ 'microsoft.operationalinsights/workspaces'\r\n| summarize by id, name\r\n| project id",
            "crossComponentResources": [
              "{subscription}"
            ],
            "value": "/subscriptions/f164a5a8-a5ce-4c29-a374-8a27bd327d18/resourceGroups/MonitoringRG/providers/Microsoft.OperationalInsights/workspaces/GlobalWatch",
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "f451ddc5-00e3-4fe7-908e-22d0be9ab59c",
            "version": "KqlParameterItem/1.0",
            "name": "detectionTime",
            "label": "Detection Time",
            "type": 4,
            "isRequired": true,
            "value": {
              "durationMs": 7776000000
            },
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000
                },
                {
                  "durationMs": 900000
                },
                {
                  "durationMs": 1800000
                },
                {
                  "durationMs": 3600000
                },
                {
                  "durationMs": 14400000
                },
                {
                  "durationMs": 43200000
                },
                {
                  "durationMs": 86400000
                },
                {
                  "durationMs": 172800000
                },
                {
                  "durationMs": 259200000
                },
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ]
            },
            "timeContext": {
              "durationMs": 86400000
            }
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - 2"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "AzureDiagnostics \n| where Category == \"FrontDoorWebApplicationFirewallLog\" \n| where TimeGenerated {detectionTime}\n| extend Id = new_guid() \n| project-reorder Id, ResourceId, action_s\n| evaluate pivot(action_s, count(), ResourceId)",
        "size": 1,
        "title": "Select the scope of the WAF policy",
        "exportFieldName": "ResourceId",
        "exportParameterName": "ResourceId",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces",
        "crossComponentResources": [
          "{workspace}"
        ],
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "$gen_group",
              "formatter": 13,
              "formatOptions": {
                "linkTarget": null,
                "showIcon": true
              }
            },
            {
              "columnMatch": "ResourceId",
              "formatter": 5
            },
            {
              "columnMatch": "Matched",
              "formatter": 8,
              "formatOptions": {
                "palette": "greenRed"
              }
            },
            {
              "columnMatch": "Blocked",
              "formatter": 8,
              "formatOptions": {
                "palette": "greenRed"
              }
            }
          ],
          "rowLimit": 500,
          "hierarchySettings": {
            "treeType": 1,
            "groupBy": [
              "ResourceId"
            ]
          },
          "labelSettings": [
            {
              "columnId": "ResourceId",
              "label": "App Gateway"
            }
          ]
        },
        "tileSettings": {
          "showBorder": false
        }
      },
      "name": "query-afd-resources"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "14e61d36-d59a-405d-8363-ac1aa8a2f491",
            "cellValue": "SelectedTabPage",
            "linkTarget": "parameter",
            "linkLabel": "Triage by Rule",
            "subTarget": "triage-by-rule",
            "preText": "Triage by Rule",
            "style": "link"
          },
          {
            "id": "93464fc4-d183-4d74-9e06-111c6de081a9",
            "cellValue": "SelectedTabPage",
            "linkTarget": "parameter",
            "linkLabel": "Triage by URL",
            "subTarget": "triage-by-url",
            "preText": "Triage ",
            "style": "link"
          }
        ]
      },
      "name": "TabNavigation"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AzureDiagnostics \r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where TimeGenerated {detectionTime}\r\n| where ResourceId == '{ResourceId}'\r\n| summarize Count = count() by ruleName_s, details_msg_s, details_data_s, action_s\r\n| order by Count desc\r\n| project-reorder Count\r\n// add sparklines\r\n| join kind=inner (AzureDiagnostics | where Category == \"FrontDoorWebApplicationFirewallLog\" | where TimeGenerated {detectionTime} | where ResourceId == '{ResourceId}' \r\n                                    | make-series Trend = count() on TimeGenerated from {detectionTime:start} to {detectionTime:end} step (time({detectionTime:seconds} seconds) / 20)  by ruleName_s\r\n    ) on ruleName_s\r\n| extend Id = new_guid()",
              "size": 0,
              "showAnalytics": true,
              "title": "Rules that got triggered",
              "exportFieldName": "ruleName_s",
              "exportParameterName": "RuleName",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Count",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "greenRed"
                    }
                  },
                  {
                    "columnMatch": "ruleSetType_s",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "ruleId_s",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Url",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "Url",
                      "linkLabel": "Go to Core Rule Set Project GitHub for this rule"
                    }
                  },
                  {
                    "columnMatch": "Trend",
                    "formatter": 10,
                    "formatOptions": {
                      "palette": "yellowOrangeRed"
                    }
                  },
                  {
                    "columnMatch": "TimeGenerated",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Id",
                    "formatter": 5
                  }
                ],
                "sortBy": [
                  {
                    "itemKey": "$gen_heatmap_Count_0",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_heatmap_Count_0",
                  "sortOrder": 2
                }
              ]
            },
            "customWidth": "100",
            "name": "query - violated rules"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AzureDiagnostics\r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where ResourceId == '{ResourceId}' and ruleName_s == '{RuleName}'\r\n| where TimeGenerated {detectionTime}\r\n| distinct host_s",
              "size": 0,
              "title": "Hosts Affected",
              "exportFieldName": "host_s",
              "exportParameterName": "HostName",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "hostname_s_noport",
                    "formatter": 5
                  }
                ]
              }
            },
            "customWidth": "15",
            "showPin": true,
            "name": "Affected Hosts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AzureDiagnostics\r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where TimeGenerated {detectionTime}\r\n| where ResourceId == '{ResourceId}' and ruleName_s == '{RuleName}'\r\n| where host_s == '{HostName}'\r\n| project-reorder host_s, trackingReference_s\r\n| join kind=inner (AzureDiagnostics | where Category == \"FrontDoorAccessLog\" | where TimeGenerated {detectionTime}) on trackingReference_s\r\n| distinct hostName_s1, httpMethod_s1, requestUri_s1, originUrl_s1\r\n| order by hostName_s1, requestUri_s1, httpMethod_s1, originUrl_s1\r\n| extend id = new_guid()",
              "size": 0,
              "showAnalytics": true,
              "title": "Hosts and urls impacted by selected rule",
              "exportedParameters": [
                {
                  "fieldName": "httpMethod_s1",
                  "parameterName": "Method",
                  "parameterType": 1
                },
                {
                  "fieldName": "originalRequestUriWithArgs_s1",
                  "parameterName": "FullUri",
                  "parameterType": 1
                },
                {
                  "fieldName": "requestUri_s1",
                  "parameterName": "RequestUri",
                  "parameterType": 1
                }
              ],
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "requestUri_s",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "encodedRequestUri",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "id",
                    "formatter": 5
                  }
                ],
                "rowLimit": 1000,
                "hierarchySettings": {
                  "treeType": 1,
                  "groupBy": [
                    "requestUri_s1"
                  ],
                  "expandTopLevel": true,
                  "finalBy": "requestUri_s"
                }
              }
            },
            "customWidth": "60",
            "name": "affected urls"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AzureDiagnostics\r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where ResourceId == '{ResourceId}'\r\n| where TimeGenerated {detectionTime}\r\n| distinct trackingReference_s\r\n| join kind=inner (AzureDiagnostics | where Category == \"FrontDoorAccessLog\" | where TimeGenerated {detectionTime}) on trackingReference_s\r\n| where hostName_s == '{HostName}' and httpMethod_s == '{Method}' and requestUri_s == ```{RequestUri}```\r\n| project trackingReference_s\r\n| extend access_log = strcat(\"AzureDiagnostics | where Category == \\\"FrontDoorAccessLog\\\" | where TimeGenerated {detectionTime} | where trackingReference_s == \\\"\", trackingReference_s, \"\\\"\")\r\n| extend firewall_log = strcat(\"AzureDiagnostics | where Category == \\\"FrontDoorWebApplicationFirewallLog\\\" | where TimeGenerated {detectionTime} | where trackingReference_s == \\\"\", trackingReference_s, \"\\\"\")",
              "size": 0,
              "title": "Requests on selected host and url",
              "exportFieldName": "trackingReference_s",
              "exportParameterName": "TransactionId",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "transactionId_g",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40%"
                    }
                  },
                  {
                    "columnMatch": "access_log",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "OpenBlade",
                      "linkLabel": "Find in Access Log",
                      "linkIsContextBlade": true,
                      "bladeOpenContext": {
                        "bladeName": "LogsBlade",
                        "extensionName": "Microsoft_Azure_Monitoring_Logs",
                        "bladeParameters": [
                          {
                            "name": "resourceId",
                            "source": "parameter",
                            "value": "workspace"
                          },
                          {
                            "name": "source",
                            "source": "static",
                            "value": "Microsoft_Azure_Monitoring_Logs/LogsBlade"
                          },
                          {
                            "name": "query",
                            "source": "cell",
                            "value": ""
                          }
                        ]
                      }
                    }
                  },
                  {
                    "columnMatch": "firewall_log",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "OpenBlade",
                      "linkLabel": "Find in Firewall Log",
                      "linkIsContextBlade": true,
                      "bladeOpenContext": {
                        "bladeName": "LogsBlade",
                        "extensionName": "Microsoft_Azure_Monitoring_Logs",
                        "bladeParameters": [
                          {
                            "name": "resourceId",
                            "source": "parameter",
                            "value": "workspace"
                          },
                          {
                            "name": "source",
                            "source": "static",
                            "value": "Microsoft_Azure_Monitoring_Logs/LogsBlade"
                          },
                          {
                            "name": "query",
                            "source": "cell",
                            "value": ""
                          }
                        ]
                      }
                    }
                  }
                ]
              }
            },
            "customWidth": "25",
            "name": "ImpactedRequestsFromSelectedUri"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AzureDiagnostics \r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where trackingReference_s == '{TransactionId}'\r\n| extend Id = new_guid()\r\n| project Id, action_s, ruleName_s, host_s, requestUri_s, details_msg_s, details_data_s, trackingReference_s, TimeGenerated\r\n",
              "size": 0,
              "title": "Rules that got triggered for selected request",
              "exportedParameters": [
                {
                  "fieldName": "trackingReference_s",
                  "parameterName": "TransactionId"
                },
                {
                  "fieldName": "ruleName_s",
                  "parameterName": "RuleName",
                  "parameterType": 1
                },
                {
                  "fieldName": "details_msg_s",
                  "parameterName": "details",
                  "parameterType": 1
                },
                {
                  "fieldName": "details_data_s",
                  "parameterName": "matcheddata",
                  "parameterType": 1
                },
                {
                  "fieldName": "requestUri_s",
                  "parameterName": "FullUri",
                  "parameterType": 1
                }
              ],
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "action_s",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Matched",
                          "representation": "2",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Blocked",
                          "representation": "4",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "more",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "ruleId_s",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "{RuleId}",
                          "representation": "yellow",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Url",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "Url",
                      "linkLabel": "Go to Core Rule Set Project GitHub for this rule"
                    }
                  },
                  {
                    "columnMatch": "statusFromAction",
                    "formatter": 5,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "action_s",
                    "label": "action"
                  },
                  {
                    "columnId": "details_data_s",
                    "label": "matched data"
                  },
                  {
                    "columnId": "TimeGenerated",
                    "label": "time generated"
                  }
                ]
              }
            },
            "name": "TriggeredRules"
          },
          {
            "type": 1,
            "content": {
              "json": "## Selection Summary:\r\n\r\nYou were looking for example requests which were impacted by WAF Rule: **{RuleName}**.  \r\n\r\nOn the host with name \"*{HostName}*\" and url \"*{FullUri}*\" you have found an HTTP request, impacted by this rule, with transaction id equal to *{TransactionId}*.  \r\n\r\nMore info on this request and the selected rule:\r\n- Details: {details}\r\n- Matched Data: {matcheddata}"
            },
            "name": "text - 7"
          }
        ],
        "exportParameters": true
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTabPage",
        "comparison": "isEqualTo",
        "value": "triage-by-rule"
      },
      "name": "Triage by rule"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AzureDiagnostics \r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where ResourceId == '{ResourceId}'\r\n| where TimeGenerated {detectionTime}\r\n| distinct host_s",
              "size": 0,
              "title": "Hostnames with entries in Firewall Log",
              "exportFieldName": "host_s",
              "exportParameterName": "HostName",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "hostname_s",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "100%"
                    }
                  }
                ]
              },
              "sortBy": []
            },
            "customWidth": "10",
            "name": "Hostnames with entries in Firewall Log"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AzureDiagnostics\r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where ResourceId == '{ResourceId}'\r\n| where host_s == '{HostName}'\r\n| where TimeGenerated {detectionTime}\r\n| join kind=inner (AzureDiagnostics | where Category == \"FrontDoorAccessLog\" | where ResourceId == '{ResourceId}')\r\n  on trackingReference_s\r\n| distinct  requestUri_s, httpMethod_s1, originUrl_s1, httpStatusDetails_s1\r\n| extend Id = new_guid()\r\n",
              "size": 0,
              "title": "Paths which have triggered firewall rules",
              "exportedParameters": [
                {
                  "fieldName": "requestUri_s",
                  "parameterName": "RequestUri"
                },
                {
                  "fieldName": "originalRequestUriWithArgs_s1",
                  "parameterName": "RequestUriWithArgs",
                  "parameterType": 1
                },
                {
                  "fieldName": "httpMethod_s1",
                  "parameterName": "HttpMethod",
                  "parameterType": 1
                },
                {
                  "fieldName": "httpStatusDetails_s1",
                  "parameterName": "HttpStatus",
                  "parameterType": 1
                },
                {
                  "parameterType": 1
                }
              ],
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "encodedRequestUriWithArgs",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Id",
                    "formatter": 5
                  }
                ],
                "filter": true,
                "hierarchySettings": {
                  "treeType": 1,
                  "groupBy": [
                    "requestUri_s",
                    "httpMethod_s1"
                  ],
                  "finalBy": "httpStatus_d1"
                }
              },
              "sortBy": []
            },
            "customWidth": "60",
            "name": "Paths which have triggered firewall rules"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AzureDiagnostics\r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n| where ResourceId == '{ResourceId}'\r\n| where host_s == '{HostName}'\r\n| where TimeGenerated {detectionTime}\r\n| join kind=inner (AzureDiagnostics | where Category == \"FrontDoorAccessLog\" | where ResourceId == '{ResourceId}') on trackingReference_s\r\n| where httpMethod_s1 == '{HttpMethod}' and httpStatusDetails_s1 == '{HttpStatus}'\r\n| distinct trackingReference_s\r\n| extend access_log = strcat(\"AzureDiagnostics | where Category == \\\"FrontDoorAccessLog\\\" | where TimeGenerated {detectionTime} | where trackingReference_s == \\\"\", trackingReference_s, \"\\\"\")\r\n| extend firewall_log = strcat(\"AzureDiagnostics | where Category == \\\"FrontDoorWebApplicationFirewallLog\\\" | where TimeGenerated {detectionTime} | where trackingReference_s == \\\"\", trackingReference_s, \"\\\"\")",
              "size": 0,
              "title": "Requests on selected host and url",
              "exportFieldName": "trackingReference_s",
              "exportParameterName": "TransactionId",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "transactionId_g",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "40%"
                    }
                  },
                  {
                    "columnMatch": "access_log",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "OpenBlade",
                      "linkLabel": "Find in Access Log",
                      "linkIsContextBlade": true,
                      "bladeOpenContext": {
                        "bladeName": "LogsBlade",
                        "extensionName": "Microsoft_Azure_Monitoring_Logs",
                        "bladeParameters": [
                          {
                            "name": "resourceId",
                            "source": "parameter",
                            "value": "workspace"
                          },
                          {
                            "name": "source",
                            "source": "static",
                            "value": "Microsoft_Azure_Monitoring_Logs/LogsBlade"
                          },
                          {
                            "name": "query",
                            "source": "cell",
                            "value": ""
                          }
                        ]
                      }
                    }
                  },
                  {
                    "columnMatch": "firewall_log",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "OpenBlade",
                      "linkLabel": "Find in Firewall Log",
                      "linkIsContextBlade": true,
                      "bladeOpenContext": {
                        "bladeName": "LogsBlade",
                        "extensionName": "Microsoft_Azure_Monitoring_Logs",
                        "bladeParameters": [
                          {
                            "name": "resourceId",
                            "source": "parameter",
                            "value": "workspace"
                          },
                          {
                            "name": "source",
                            "source": "static",
                            "value": "Microsoft_Azure_Monitoring_Logs/LogsBlade"
                          },
                          {
                            "name": "query",
                            "source": "cell",
                            "value": ""
                          }
                        ]
                      }
                    }
                  }
                ]
              }
            },
            "customWidth": "25",
            "name": "query - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "AzureDiagnostics \r\n| where Category == \"FrontDoorWebApplicationFirewallLog\"\r\n//| where TimeGenerated {detectionTime}\r\n| where trackingReference_s == '{TransactionId}'\r\n| extend Id = new_guid()\r\n| project Id, action_s, ruleName_s, host_s, requestUri_s, details_msg_s, details_data_s, trackingReference_s, TimeGenerated",
              "size": 0,
              "title": "Rules that got triggered for selected request",
              "exportedParameters": [
                {
                  "fieldName": "trackingReference_s",
                  "parameterName": "TransactionId"
                },
                {
                  "fieldName": "details_msg_s",
                  "parameterName": "details",
                  "parameterType": 1
                },
                {
                  "fieldName": "details_data_s",
                  "parameterName": "matcheddata",
                  "parameterType": 1
                }
              ],
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{workspace}"
              ],
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "action_s",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Matched",
                          "representation": "2",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Blocked",
                          "representation": "4",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "more",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "ruleId_s",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "{RuleId}",
                          "representation": "yellow",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Url",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "Url",
                      "linkLabel": "Go to Core Rule Set Project GitHub for this rule"
                    }
                  },
                  {
                    "columnMatch": "statusFromAction",
                    "formatter": 5,
                    "numberFormat": {
                      "unit": 0,
                      "options": {
                        "style": "decimal"
                      }
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "action_s",
                    "label": "action"
                  },
                  {
                    "columnId": "details_data_s",
                    "label": "matched data"
                  },
                  {
                    "columnId": "TimeGenerated",
                    "label": "time generated"
                  }
                ]
              }
            },
            "name": "TriggeredRules - By Url"
          },
          {
            "type": 1,
            "content": {
              "json": "## Selection Summary:\r\n\r\nYou were looking for requests which triggered a WAF rule on url: _{RequestUri}_.  \r\nYou have found an HTTP request, impacted by this rule, with transaction id equal to *{TransactionId}*.  \r\n\r\nMore info on this request and the selected rule:\r\n- Details: {details}\r\n- Matched Data: {matcheddata}"
            },
            "name": "text - 7 - Copy"
          }
        ],
        "exportParameters": true
      },
      "conditionalVisibility": {
        "parameterName": "SelectedTabPage",
        "comparison": "isEqualTo",
        "value": "triage-by-url"
      },
      "name": "Triage by URL"
    }
  ],
  "defaultResourceIds": [
    "value::all"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}